## Лабораторная работа №1

# Цель
1. Создать бакет в Object Storage и развернуть на нем простой статический сайт
2. Создать облачную функцию, позволяющую добавлять файлы в созданный бакет
3. Создать триггер, вызываемый при создании нового файла в бакете
4. Создать облачную функцию, запускаемую триггером, которая добавляет ссылку на вновь созданный файл в html

# Создание бакета 
1. Переходим в Object Storage, создаем бакет unn-cloud-bucket-<ваша фамилия>
с параметрами:
```pre
максимальный размер 1ГБ
Доступ на чтение объектов - публичный
остальные значения оставляем по умолчанию
```

2. Переходим в бакет, вкладка "Веб-сайт". Устанавливаем переключатель в положение "Хостинг". В качестве главной страницы указываем index.html. Нажимаем "Сохранить"
3. Переходим на вкладку "Объекты" и загружаем в бакет файл index.html
4. Переходим по ссылке https://unn-cloud-bucket-<ваша фамилия>.website.yandexcloud.net/, вы должны увидеть форму для загрузки файла (содержимое index.html)
5. Даем сервисной учетке права на работу с бакетом (в списке бакетов, выбираем ACL бакетов, указываем сервисную учетку backet-acc и даем ей права READ\WRITE для вашего бакета)


# Создание функции загрузки 
1. Переходим в Cloud Function, создаем функцию с именем unn-cloud-function-upload-<ваша фамилия>
2. Выбираем Node.js (18 версия)  в качестве среды исполнения
3. Копируем в редактор код функции из папки unn-cloud-upload-function
4. создаем файл package.json и копируем его содержимое из папки unn-cloud-upload-function
5. Указываем сервисный аккаунт, под которым будет выполняться функция - bucket-acc
6. указываем переменную окружения bucket = unn-cloud-bucket-<ваша фамилия> (обратите внимание - в коде функции используются переменные окружения)
7. Указываем секреты Yandex Lockbox - accessKeyId и secretAccessKey (лежат в key_for_bucket)
8. Нажимаем "сохранить изменения" и смотрим на логи "сборки" - ошибок в них быть не должно.
9. Переходим на вкладку "Обзор", и открываем доступ к функции (переключатель "Публичная функция")
10. Копируем ссылку для вызова и в файле index.html заменяем action в форме на эту ссылку (наша задача - сделать так, чтобы форма посылала данные нашей облачной функции)
11. Выкладываем новый файл index.html в бакет

# Промежуточная проверка
1. Идем по адресу https://unn-cloud-bucket-<ваша фамилия>.website.yandexcloud.net/. Нажимаем в браузере Ctrl-U. Смотрим код формы, убеждаемся, что action правильный (ведет на нашу функцию)
2. В форме выбираем файл для загрузке, загружаем его. 
3. Смотрим в нашем бакете, убеждаемся, что в нем появился новый файл

# Создание функции, которая будет вызываться при добавлении в хранилище нового объекта
1. Переходим в Cloud Function, создаем функцию с именем unn-cloud-function-trg-<ваша фамилия>
2. Выбираем Node.js (18 версия)  в качестве среды исполнения
3. Копируем в редактор код функции из папки unn-cloud-trg-function
4. создаем файл package.json и копируем его содержимое из папки unn-cloud-trg-function
5. Указываем сервисный аккаунт, под которым будет выполняться функция - bucket-acc
6. указываем переменную окружения 

```pre
bucket = unn-cloud-bucket-<ваша фамилия> 
``` 

(обратите внимание - в коде функции используются переменные окружения)

7. Указываем секреты Yandex Lockbox - accessKeyId и secretAccessKey (лежат в key_for_bucket)
8. Нажимаем "сохранить изменения" и смотрим на логи "сборки" - ошибок в них быть не должно.

# Создание триггера
1. В разделе Cloud Function переходим в раздел триггеры
2. Создаем новый триггер:
```pre
имя: unn-cloud-trg-<ваша фамилия>
Тип: Object Storage
Бакет: unn-cloud-bucket-<ваша фамилия> (бакет, который вы создавали)
Тип событий: создание объекта
Функция: nn-cloud-function-trg-<ваша фамилия>
Сервисный аккаунт: backet-acc
```

# Проверка
1. Переходим на сайт нашего бакета (https://unn-cloud-bucket-<ваша фамилия>.website.yandexcloud.net/)
2. Добавляем новый файл
3. Переходим по ссылке внизу - должны получить список всех файлов в папке upload

# Добавление API Gateway
1. Переходим в раздел Api Gateway, создаем unn-cloud-gateway-<ваша фамилия>
2. Добавляем раздел post:
```yaml
post:
      x-yc-apigateway-integration:
        type: cloud_functions
        function_id: xxx <-идентификатор функции unn-cloud-function-upload-<ваша фамилия>
        service_account_id: xxxxxxxxxx <-идентификатор сервисного аккаунта
```
в итоге, должно получиться что-то вроде

```yaml
openapi: 3.0.0
info:
  title: Sample API
  version: 1.0.0
paths:
  /:
    get:
      x-yc-apigateway-integration:
        type: dummy
        content:
          '*': Hello, World!
        http_code: 200
        http_headers:
          Content-Type: text/plain
    post:
      x-yc-apigateway-integration:
        type: cloud_functions
        function_id: xxx_ваш_id_функции_____
        service_account_id: xxxxxxxxxxx
```
3. После создания шлюза, переходим на вкладку обзор и копируем ссылку на него (она будет выглядеть как-то вот так: https://xxxxxxxxxxxxxx.apigw.yandexcloud.net)
4. Редактируем файл файле index.html, заменяем action в форме на эту ссылку на шлюз.
5. Идем в настройку функции unn-cloud-function-upload-<ваша фамилия>, снимаем переключатель "публичная функция". Функция станет закрытой - ее будет невозможно вызвать ин интернета. теперь мы ее вызываем посредством шлюза.

# Финальная проверка
1. переходим по ссылке https://unn-cloud-bucket-<ваша фамилия>.website.yandexcloud.net/
2. Загружаем файл через нашу форму загрузки
3. Убеждаемся, что он появился в папке upload нашего бакета
4. Убеждаемся, что он появился в списке загруженных файлов, при переходе по ссылке (https://unn-cloud-bucket-<ваша фамилия>.website.yandexcloud.net/list.html)

# Как это работает?
1. Мы опубликовали статический сайт с помощью Object Storage
2. Форма, определенная в Index.html отправляет данные на наш шлюз, который вызывает облачную функцию unn-cloud-function-upload-<ваша фамилия>, которая помещает файл в папку upload
3. При добавлении нового файла запускается триггер, который вызывает функцию unn-cloud-function-trg-<ваша фамилия>, которая получает список всех файлов, расположенных в папке upload и генерирует файл list.html, который включает в себя ссылки на все эти файлы.